{% extends "base.html" %}

{% block title %}Configuration - Customer Sentiment Alert System{% endblock %}

{% block page_title %}Configuration{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <!-- Email Configuration -->
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-envelope me-2"></i>
                    Email Configuration
                </h6>
            </div>
            <div class="card-body">
                <form id="emailConfigForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="smtpServer" class="form-label">SMTP Server</label>
                                <input type="text" class="form-control" id="smtpServer" value="{{ config.SMTP_SERVER }}" readonly>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="smtpPort" class="form-label">SMTP Port</label>
                                <input type="number" class="form-control" id="smtpPort" value="{{ config.SMTP_PORT }}" readonly>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="emailUsername" class="form-label">Email Username</label>
                                <input type="email" class="form-control" id="emailUsername" value="{{ config.EMAIL_USERNAME if config.EMAIL_USERNAME else '' }}" readonly>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="alertEmail" class="form-label">Alert Email</label>
                                <input type="email" class="form-control" id="alertEmail" value="{{ config.ALERT_EMAIL }}" readonly>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="emailConfigured" {{ 'checked' if config.EMAIL_USERNAME and config.EMAIL_PASSWORD else '' }} disabled>
                            <label class="form-check-label" for="emailConfigured">
                                Email system configured
                            </label>
                        </div>
                    </div>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Email configuration is managed through environment variables. Update your .env file to modify these settings.
                    </div>
                </form>
            </div>
        </div>

        <!-- Monitoring Configuration -->
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-search me-2"></i>
                    Monitoring Configuration
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Monitoring Interval</label>
                            <div class="input-group">
                                <input type="number" class="form-control" value="{{ config.MONITORING_INTERVAL }}" readonly>
                                <span class="input-group-text">seconds</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Sentiment Threshold</label>
                            <input type="number" class="form-control" step="0.1" value="{{ config.SENTIMENT_THRESHOLD }}" readonly>
                        </div>
                    </div>
                </div>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    Monitoring settings are configured in the config.py file. Restart the application after making changes.
                </div>
            </div>
        </div>

        <!-- Company Names -->
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-building me-2"></i>
                    Company Names to Monitor
                </h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Monitored Companies</label>
                    <div class="list-group">
                        {% for company in config.COMPANY_NAMES %}
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            {{ company }}
                            <span class="badge bg-primary rounded-pill">Active</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    Company names are configured in the config.py file. Add your company names to the COMPANY_NAMES list.
                </div>
            </div>
        </div>

        <!-- Keywords -->
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-key me-2"></i>
                    Monitoring Keywords
                </h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Keywords to Monitor</label>
                    <div class="d-flex flex-wrap">
                        {% for keyword in config.MONITOR_KEYWORDS %}
                        <span class="badge bg-secondary me-2 mb-2">{{ keyword }}</span>
                        {% endfor %}
                    </div>
                </div>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    Keywords are configured in the config.py file. Modify the MONITOR_KEYWORDS list to change what terms are monitored.
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <!-- System Status -->
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-cogs me-2"></i>
                    System Status
                </h6>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span>Sentiment Analyzer</span>
                    <span class="badge bg-success" id="sentimentStatus">Ready</span>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span>Web Scraper</span>
                    <span class="badge bg-success" id="scraperStatus">Ready</span>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span>Database</span>
                    <span class="badge bg-success" id="databaseStatus">Connected</span>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span>Email System</span>
                    <span class="badge bg-{{ 'success' if config.EMAIL_USERNAME and config.EMAIL_PASSWORD else 'warning' }}" id="emailStatus">
                        {{ 'Configured' if config.EMAIL_USERNAME and config.EMAIL_PASSWORD else 'Not Configured' }}
                    </span>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                    <span>Monitoring</span>
                    <span class="badge bg-info" id="monitoringStatus">Stopped</span>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-bolt me-2"></i>
                    Quick Actions
                </h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-primary" onclick="startMonitoring()">
                        <i class="fas fa-play me-2"></i>
                        Start Monitoring
                    </button>
                    <button class="btn btn-secondary" onclick="stopMonitoring()">
                        <i class="fas fa-stop me-2"></i>
                        Stop Monitoring
                    </button>
                    <button class="btn btn-info" onclick="testSystem()">
                        <i class="fas fa-vial me-2"></i>
                        Test System
                    </button>
                    <button class="btn btn-warning" onclick="manualScan()">
                        <i class="fas fa-search me-2"></i>
                        Manual Scan
                    </button>
                    <button class="btn btn-success" onclick="sendTestEmail()">
                        <i class="fas fa-envelope me-2"></i>
                        Send Test Email
                    </button>
                </div>
            </div>
        </div>

        <!-- Environment Variables -->
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-file-code me-2"></i>
                    Environment Variables
                </h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Required Variables</label>
                    <div class="list-group list-group-flush">
                        <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                            EMAIL_USERNAME
                            <span class="badge bg-{{ 'success' if config.EMAIL_USERNAME else 'danger' }}">
                                {{ 'Set' if config.EMAIL_USERNAME else 'Missing' }}
                            </span>
                        </div>
                        <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                            EMAIL_PASSWORD
                            <span class="badge bg-{{ 'success' if config.EMAIL_PASSWORD else 'danger' }}">
                                {{ 'Set' if config.EMAIL_PASSWORD else 'Missing' }}
                            </span>
                        </div>
                        <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                            TWITTER_API_KEY
                            <span class="badge bg-warning">
                                Optional
                            </span>
                        </div>
                    </div>
                </div>
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Create a .env file in the project root to set these variables.
                </div>
            </div>
        </div>

        <!-- Log Files -->
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-file-alt me-2"></i>
                    Log Files
                </h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Log File</label>
                    <div class="input-group">
                        <input type="text" class="form-control" value="{{ config.LOG_FILE }}" readonly>
                        <button class="btn btn-outline-secondary" type="button" onclick="viewLogs()">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Log Level</label>
                    <input type="text" class="form-control" value="{{ config.LOG_LEVEL }}" readonly>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function startMonitoring() {
        showLoading();
        fetch('/api/start-monitoring', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.error) {
                alert('Failed to start monitoring: ' + data.error);
            } else {
                alert('Monitoring started successfully');
                document.getElementById('monitoringStatus').textContent = 'Running';
                document.getElementById('monitoringStatus').className = 'badge bg-success';
            }
        })
        .catch(error => {
            hideLoading();
            alert('Error starting monitoring: ' + error);
        });
    }
    
    function stopMonitoring() {
        showLoading();
        fetch('/api/stop-monitoring', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.error) {
                alert('Failed to stop monitoring: ' + data.error);
            } else {
                alert('Monitoring stopped successfully');
                document.getElementById('monitoringStatus').textContent = 'Stopped';
                document.getElementById('monitoringStatus').className = 'badge bg-secondary';
            }
        })
        .catch(error => {
            hideLoading();
            alert('Error stopping monitoring: ' + error);
        });
    }
    
    function viewLogs() {
        // Show recent log entries
        fetch('/api/logs')
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error loading logs: ' + data.error);
                } else {
                    showLogModal(data.logs);
                }
            })
            .catch(error => {
                alert('Error loading logs: ' + error);
            });
    }
    
    function showLogModal(logs) {
        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.innerHTML = `
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">System Logs - Recent Entries</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div style="max-height: 400px; overflow-y: auto; background-color: #f8f9fa; padding: 15px; border-radius: 5px; font-family: monospace; font-size: 12px;">
                            ${logs.map(log => `<div style="margin-bottom: 5px;">${log}</div>`).join('')}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        const bootstrapModal = new bootstrap.Modal(modal);
        bootstrapModal.show();
        
        modal.addEventListener('hidden.bs.modal', function () {
            document.body.removeChild(modal);
        });
    }
    
    // Update system status on page load (removed auto-refresh)
    document.addEventListener('DOMContentLoaded', function() {
        // Only update status badges, don't run full system test
        updateSystemStatus();
    });
    
    function updateSystemStatus() {
        // Update monitoring status based on current state
        fetch('/api/alerts')
            .then(response => response.json())
            .then(data => {
                if (!data.error) {
                    // System is working if we can get alerts
                    document.getElementById('sentimentStatus').textContent = 'Ready';
                    document.getElementById('sentimentStatus').className = 'badge bg-success';
                    document.getElementById('scraperStatus').textContent = 'Ready';
                    document.getElementById('scraperStatus').className = 'badge bg-success';
                    document.getElementById('databaseStatus').textContent = 'Connected';
                    document.getElementById('databaseStatus').className = 'badge bg-success';
                }
            })
            .catch(error => {
                console.log('Status check failed:', error);
            });
    }
</script>
{% endblock %}
